<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MindKeep</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app">
        <div class="app-header">
            <h1>MindKeep</h1>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search notes..." class="search-input">
            </div>
            <button id="updateBtn" class="update-btn" onclick="checkForUpdates()">Check Updates</button>
        </div>
        
        <div class="app-body">
            <div class="sidebar">
                <div class="sidebar-header">
                    <select id="categorySelector" class="category-selector">
                        <option value="all">All Notes</option>
                    </select>
                    <div class="category-actions">
                        <button class="category-btn" onclick="createNewCategory()">+ Category</button>
                        <button class="category-btn" onclick="manageCategories()">Manage</button>
                    </div>
                    <button class="new-note-btn" onclick="createNewNote()">+ New Note</button>
                </div>
                <div id="notesList" class="notes-list">
                    <div class="no-notes-message">No notes found</div>
                </div>
            </div>
            
            <div class="main-content">
                <div id="welcomeScreen" class="welcome">
                    <h2>Welcome to MindKeep</h2>
                    <p>Your offline knowledge vault</p>
                    <button class="new-note-btn" onclick="createNewNote()">Create First Note</button>
                </div>
                
                <div id="viewer" class="viewer" style="display: none;">
                    <div class="viewer-header">
                        <h1 id="viewerTitle"></h1>
                        <div class="viewer-actions">
                            <button onclick="editNote()" class="edit-btn">Edit</button>
                            <button onclick="deleteNote()" class="delete-btn">Delete</button>
                        </div>
                    </div>
                    <div id="viewerMeta" class="viewer-meta"></div>
                    <div id="viewerContent" class="viewer-content"></div>
                </div>
                
                <div id="editor" class="editor" style="display: none;">
                    <div class="editor-header">
                        <input type="text" id="noteTitle" class="title-input" placeholder="Note title...">
                        <div class="editor-actions">
                            <button onclick="saveCurrentNote()" class="save-btn">Save</button>
                            <button onclick="cancelEdit()" class="cancel-btn">Cancel</button>
                        </div>
                    </div>
                    <div class="editor-body">
                        <select id="noteCategory" class="tags-input">
                            <option value="">Select Category</option>
                        </select>
                        <input type="text" id="noteTags" class="tags-input" placeholder="Tags (comma separated)...">
                        <input type="text" id="noteDescription" class="tags-input" placeholder="Description...">
                        <div id="noteContent" class="content-editor" contenteditable="true" data-placeholder="Start writing your note..."></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Category Modal -->
    <div id="categoryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>üé® Create New Category</h3>
            <input type="text" id="categoryNameInput" placeholder="Category name" class="modal-input">
            <input type="color" id="categoryColorInput" value="#4a9eff" class="modal-input">
            <div class="modal-buttons">
                <button onclick="saveCategoryModal()" class="modal-btn save">Create</button>
                <button onclick="closeCategoryModal()" class="modal-btn cancel">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Alert Modal -->
    <div id="alertModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 id="alertTitle">‚ÑπÔ∏è Information</h3>
            <p id="alertMessage"></p>
            <div class="modal-buttons">
                <button onclick="closeAlert()" class="modal-btn save">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Manage Categories Modal -->
    <div id="manageCategoriesModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>‚öôÔ∏è Manage Categories</h3>
            <div id="categoriesList" class="categories-list"></div>
            <div class="modal-buttons">
                <button onclick="closeManageCategoriesModal()" class="modal-btn cancel">Close</button>
            </div>
        </div>
    </div>
    
    <script>
        const fs = require('fs');
        const path = require('path');
        
        // App data
        let categories = [{ name: 'General', color: '#4a9eff' }];
        let notes = [];
        const appDir = process.cwd();
        const notesDir = path.join(appDir, 'notes');
        const categoriesFile = path.join(appDir, 'categories.json');
        
        // Initialize app
        function initApp() {
            try {
                // Create directories
                if (!fs.existsSync(notesDir)) {
                    fs.mkdirSync(notesDir, { recursive: true });
                }
                
                // Load categories
                if (fs.existsSync(categoriesFile)) {
                    try {
                        const data = fs.readFileSync(categoriesFile, 'utf8');
                        categories = JSON.parse(data);
                    } catch (e) {
                        console.error('Error loading categories:', e);
                    }
                }
                
                // Load notes
                loadNotes();
                updateCategorySelector();
                updateNotesList();
            } catch (error) {
                console.error('Initialization error:', error);
                updateCategorySelector();
                updateNotesList();
            }
        }
        
        function loadNotes() {
            notes = [];
            try {
                if (fs.existsSync(notesDir)) {
                    const files = fs.readdirSync(notesDir);
                    files.forEach(file => {
                        if (file.endsWith('.json')) {
                            try {
                                const data = fs.readFileSync(path.join(notesDir, file), 'utf8');
                                notes.push(JSON.parse(data));
                            } catch (e) {
                                console.error('Error loading note:', e);
                            }
                        }
                    });
                }
                notes.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            } catch (error) {
                console.error('Error loading notes:', error);
            }
        }
        
        let currentCategory = 'all';
        
        function updateCategorySelector() {
            const selector = document.getElementById('categorySelector');
            const noteCategory = document.getElementById('noteCategory');
            
            const options = '<option value="all">All Notes</option>' + 
                categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
            selector.innerHTML = options;
            selector.value = currentCategory;
            
            // Add change event listener
            selector.onchange = function() {
                currentCategory = this.value;
                updateNotesList();
            };
            
            const noteOptions = '<option value="">Select Category</option>' + 
                categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
            noteCategory.innerHTML = noteOptions;
        }
        
        function updateNotesList() {
            const notesList = document.getElementById('notesList');
            
            // Filter notes by selected category
            const filteredNotes = currentCategory === 'all' ? 
                notes : notes.filter(note => note.category === currentCategory);
            
            if (filteredNotes.length === 0) {
                notesList.innerHTML = '<div class="no-notes-message">No notes found</div>';
                return;
            }
            
            notesList.innerHTML = filteredNotes.map(note => {
                const category = categories.find(cat => cat.name === note.category) || { color: '#4a9eff' };
                return `
                    <div class="note-item" style="border-left: 4px solid ${category.color}; padding: 1rem; margin-bottom: 0.5rem; background: #404040; border-radius: 4px; cursor: pointer;" onclick="viewNote('${note.id}')">
                        <div style="font-weight: bold; color: #e0e0e0;">${note.title}</div>
                        <div style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;">${new Date(note.updatedAt).toLocaleDateString()}</div>
                    </div>
                `;
            }).join('');
        }
        
        let currentNote = null;
        
        function viewNote(noteId) {
            currentNote = notes.find(note => note.id === noteId);
            if (currentNote) {
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('editor').style.display = 'none';
                document.getElementById('viewer').style.display = 'flex';
                
                document.getElementById('viewerTitle').textContent = currentNote.title;
                document.getElementById('viewerMeta').innerHTML = `
                    <span>Category: ${currentNote.category}</span> ‚Ä¢ 
                    <span>Created: ${new Date(currentNote.createdAt).toLocaleDateString()}</span> ‚Ä¢ 
                    <span>Updated: ${new Date(currentNote.updatedAt).toLocaleDateString()}</span>
                `;
                document.getElementById('viewerContent').innerHTML = currentNote.content || '<em>No content</em>';
            }
        }
        
        function editNote() {
            if (currentNote) {
                document.getElementById('viewer').style.display = 'none';
                document.getElementById('editor').style.display = 'flex';
                
                document.getElementById('noteTitle').value = currentNote.title;
                document.getElementById('noteContent').innerHTML = currentNote.content;
                document.getElementById('noteCategory').value = currentNote.category;
                document.getElementById('noteTags').value = currentNote.tags.join(', ');
                document.getElementById('noteDescription').value = currentNote.description;
            }
        }
        
        function deleteNote() {
            if (currentNote && confirm('Are you sure you want to delete this note?')) {
                try {
                    // Delete file
                    const filePath = path.join(notesDir, currentNote.id + '.json');
                    if (fs.existsSync(filePath)) {
                        fs.unlinkSync(filePath);
                    }
                    
                    // Remove from array
                    notes = notes.filter(note => note.id !== currentNote.id);
                    
                    // Update UI
                    updateNotesList();
                    
                    // Go back to welcome screen
                    document.getElementById('viewer').style.display = 'none';
                    document.getElementById('welcomeScreen').style.display = 'flex';
                    
                    currentNote = null;
                    showAlert('üóëÔ∏è Deleted', 'Note deleted successfully!');
                } catch (error) {
                    showAlert('‚ùå Error', 'Error deleting note: ' + error.message);
                }
            }
        }
        
        // Modal functions
        function showAlert(title, message) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').style.display = 'flex';
        }
        
        function closeAlert() {
            document.getElementById('alertModal').style.display = 'none';
        }
        
        function createNewCategory() {
            document.getElementById('categoryModal').style.display = 'flex';
            document.getElementById('categoryNameInput').focus();
        }
        
        function closeCategoryModal() {
            document.getElementById('categoryModal').style.display = 'none';
            document.getElementById('categoryNameInput').value = '';
            document.getElementById('categoryColorInput').value = '#4a9eff';
        }
        
        function saveCategoryModal() {
            const categoryName = document.getElementById('categoryNameInput').value.trim();
            const color = document.getElementById('categoryColorInput').value;
            
            if (categoryName) {
                if (!categories.find(cat => cat.name === categoryName)) {
                    categories.push({ name: categoryName, color: color });
                    try {
                        fs.writeFileSync(categoriesFile, JSON.stringify(categories, null, 2));
                        updateCategorySelector();
                        closeCategoryModal();
                        showAlert('‚úÖ Success', 'Category "' + categoryName + '" created!');
                    } catch (error) {
                        showAlert('‚ùå Error', 'Error saving category: ' + error.message);
                    }
                } else {
                    showAlert('‚ö†Ô∏è Warning', 'Category already exists!');
                }
            } else {
                showAlert('‚ö†Ô∏è Warning', 'Please enter a category name.');
            }
        }
        
        function manageCategories() {
            document.getElementById('manageCategoriesModal').style.display = 'flex';
            renderCategoriesList();
        }
        
        function closeManageCategoriesModal() {
            document.getElementById('manageCategoriesModal').style.display = 'none';
        }
        
        function renderCategoriesList() {
            const categoriesList = document.getElementById('categoriesList');
            
            categoriesList.innerHTML = categories.map(cat => {
                const noteCount = notes.filter(note => note.category === cat.name).length;
                return `
                    <div class="category-item" style="border-left-color: ${cat.color};">
                        <div class="category-info">
                            <span>${cat.name}</span>
                            <span style="color: #888;">(${cat.color}) - ${noteCount} notes</span>
                        </div>
                        ${cat.name !== 'General' ? 
                            `<button class="category-delete" onclick="deleteCategory('${cat.name}')">Delete</button>` : 
                            '<span style="color: #888;">Default</span>'
                        }
                    </div>
                `;
            }).join('');
        }
        
        function deleteCategory(categoryName) {
            if (confirm('Delete category "' + categoryName + '"? Notes will be moved to General.')) {
                // Move notes to General
                notes.forEach(note => {
                    if (note.category === categoryName) {
                        note.category = 'General';
                        try {
                            const filePath = path.join(notesDir, note.id + '.json');
                            fs.writeFileSync(filePath, JSON.stringify(note, null, 2));
                        } catch (error) {
                            console.error('Error updating note:', error);
                        }
                    }
                });
                
                // Remove category
                categories = categories.filter(cat => cat.name !== categoryName);
                try {
                    fs.writeFileSync(categoriesFile, JSON.stringify(categories, null, 2));
                    updateCategorySelector();
                    updateNotesList();
                    renderCategoriesList();
                    showAlert('‚úÖ Success', 'Category deleted and notes moved to General.');
                } catch (error) {
                    showAlert('‚ùå Error', 'Error deleting category: ' + error.message);
                }
            }
        }
        
        function createNewNote() {
            currentNote = null;
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('viewer').style.display = 'none';
            document.getElementById('editor').style.display = 'flex';
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').innerHTML = '';
            document.getElementById('noteCategory').value = '';
            document.getElementById('noteTags').value = '';
            document.getElementById('noteDescription').value = '';
        }
        
        function saveCurrentNote() {
            const title = document.getElementById('noteTitle').value || 'Untitled';
            const content = document.getElementById('noteContent').innerHTML;
            const category = document.getElementById('noteCategory').value || 'General';
            const tags = document.getElementById('noteTags').value.split(',').map(t => t.trim()).filter(t => t);
            const description = document.getElementById('noteDescription').value;
            
            let note;
            if (currentNote) {
                // Editing existing note
                note = {
                    ...currentNote,
                    title: title,
                    content: content,
                    category: category,
                    tags: tags,
                    description: description,
                    updatedAt: new Date().toISOString()
                };
                
                // Update in array
                const index = notes.findIndex(n => n.id === currentNote.id);
                if (index >= 0) {
                    notes[index] = note;
                }
            } else {
                // Creating new note
                note = {
                    id: Date.now().toString(),
                    title: title,
                    content: content,
                    category: category,
                    tags: tags,
                    description: description,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                notes.unshift(note);
            }
            
            try {
                const filePath = path.join(notesDir, note.id + '.json');
                fs.writeFileSync(filePath, JSON.stringify(note, null, 2));
                
                currentNote = note;
                updateNotesList();
                
                document.getElementById('editor').style.display = 'none';
                document.getElementById('viewer').style.display = 'flex';
                
                // Update viewer
                viewNote(note.id);
                
                showAlert('‚úÖ Success', 'Note "' + title + '" saved!');
            } catch (error) {
                showAlert('‚ùå Error', 'Error saving note: ' + error.message);
            }
        }
        
        function cancelEdit() {
            document.getElementById('editor').style.display = 'none';
            if (currentNote) {
                document.getElementById('viewer').style.display = 'flex';
            } else {
                document.getElementById('welcomeScreen').style.display = 'flex';
            }
        }
        
        async function checkForUpdates() {
            try {
                const response = await fetch('https://api.github.com/repos/SebastianOana/mindkeep-desktop/releases/latest');
                const release = await response.json();
                const latestVersion = release.tag_name;
                const currentVersion = '1.0.0'; // Update this when you release new versions
                
                if (latestVersion !== currentVersion) {
                    if (confirm(`New version ${latestVersion} available!\n\nCurrent: ${currentVersion}\nLatest: ${latestVersion}\n\nDownload now?`)) {
                        window.open(release.html_url, '_blank');
                    }
                } else {
                    showAlert('‚úÖ Up to Date', 'You have the latest version!');
                }
            } catch (error) {
                showAlert('‚ùå Error', 'Could not check for updates. Please check your internet connection.');
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>